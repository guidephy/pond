<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水資源管理遊戲</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        #orientation-message {
            display: none;
            text-align: center;
            font-size: 24px;
            color: #333;
        }
        #game-container {
            display: none;
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #game-area {
            width: 100%;
            height: 300px;
            position: relative;
            background-color: #e0ffe0;
            border: 1px solid #aaa;
            overflow: hidden;
        }
        #player {
            width: 20px;
            height: 20px;
            background-color: red;
            position: absolute;
            transition: all 0.1s;
        }
        #info-panel, #action-panel {
            margin-bottom: 20px;
        }
        #action-panel button {
            margin: 5px;
            padding: 10px;
        }
        #mobile-controls {
            display: none;
            justify-content: center;
            margin-top: 20px;
        }
        #mobile-controls button {
            width: 50px;
            height: 50px;
            margin: 5px;
            font-size: 20px;
        }
        .pond {
            width: 40px;
            height: 40px;
            background-color: blue;
            position: absolute;
        }
        .field {
            width: 30px;
            height: 30px;
            background-color: green;
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="orientation-message">
        請將設備轉至橫向以開始遊戲
    </div>

    <div id="game-container">
        <div id="game-area">
            <div id="player"></div>
        </div>
        <div id="info-panel">
            水資源: <span id="water">0</span> / <span id="water-capacity">0</span><br>
            金錢: <span id="money">100</span> 元<br>
            回合: <span id="turn">0</span>
        </div>
        <div id="action-panel">
            <button onclick="buildPond()">建立埤塘 (10元)</button>
            <button onclick="plantField()">種植農田 (50水)</button>
            <button onclick="harvestField()">收穫農田</button>
        </div>
        <div id="mobile-controls">
            <button ontouchstart="startMove('up')" ontouchend="stopMove()">↑</button><br>
            <button ontouchstart="startMove('left')" ontouchend="stopMove()">←</button>
            <button ontouchstart="startMove('down')" ontouchend="stopMove()">↓</button>
            <button ontouchstart="startMove('right')" ontouchend="stopMove()">→</button>
        </div>
        <div id="win-condition">
            過關條件: 金錢超過500元
        </div>
    </div>

    <script>
        let player = { x: 0, y: 0 };
        let water = 0;
        let waterCapacity = 100;
        let money = 100;
        let turn = 0;
        let ponds = [];
        let fields = [];
        let moveInterval;

        function checkOrientation() {
            if (window.innerHeight > window.innerWidth) {
                document.getElementById('orientation-message').style.display = 'block';
                document.getElementById('game-container').style.display = 'none';
            } else {
                document.getElementById('orientation-message').style.display = 'none';
                document.getElementById('game-container').style.display = 'block';
            }
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function initGame() {
            checkOrientation();
            if (isMobile()) {
                document.getElementById('mobile-controls').style.display = 'flex';
            }
            updatePlayerPosition();
            updateInfoPanel();
        }

        function updatePlayerPosition() {
            const playerElement = document.getElementById('player');
            playerElement.style.left = player.x + 'px';
            playerElement.style.top = player.y + 'px';
        }

        function updateInfoPanel() {
            document.getElementById('water').textContent = water;
            document.getElementById('water-capacity').textContent = waterCapacity;
            document.getElementById('money').textContent = money;
            document.getElementById('turn').textContent = turn;
        }

        function move(direction) {
            const step = 5;
            const gameArea = document.getElementById('game-area');
            const maxX = gameArea.clientWidth - 20;
            const maxY = gameArea.clientHeight - 20;

            switch (direction) {
                case 'up':
                    player.y = Math.max(0, player.y - step);
                    break;
                case 'down':
                    player.y = Math.min(maxY, player.y + step);
                    break;
                case 'left':
                    player.x = Math.max(0, player.x - step);
                    break;
                case 'right':
                    player.x = Math.min(maxX, player.x + step);
                    break;
            }
            updatePlayerPosition();
        }

        function startMove(direction) {
            if (moveInterval) clearInterval(moveInterval);
            moveInterval = setInterval(() => move(direction), 100);
        }

        function stopMove() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        }

        function buildPond() {
            if (money >= 10) {
                money -= 10;
                waterCapacity += 50;
                const pond = { x: player.x, y: player.y };
                ponds.push(pond);
                const pondElement = document.createElement('div');
                pondElement.className = 'pond';
                pondElement.style.left = pond.x + 'px';
                pondElement.style.top = pond.y + 'px';
                document.getElementById('game-area').appendChild(pondElement);
                updateInfoPanel();
            }
        }

        function plantField() {
            if (water >= 50) {
                water -= 50;
                const field = { x: player.x, y: player.y, growth: 0 };
                fields.push(field);
                const fieldElement = document.createElement('div');
                fieldElement.className = 'field';
                fieldElement.style.left = field.x + 'px';
                fieldElement.style.top = field.y + 'px';
                document.getElementById('game-area').appendChild(fieldElement);
                updateInfoPanel();
            }
        }

        function harvestField() {
            for (let i = 0; i < fields.length; i++) {
                if (Math.abs(fields[i].x - player.x) < 20 && Math.abs(fields[i].y - player.y) < 20) {
                    if (fields[i].growth >= 3) {
                        money += 100;
                        fields.splice(i, 1);
                        document.querySelectorAll('.field')[i].remove();
                        updateInfoPanel();
                        break;
                    }
                }
            }
        }

        function endTurn() {
            turn++;
            water = Math.min(water + ponds.length * 10, waterCapacity);
            fields.forEach(field => field.growth++);
            updateInfoPanel();
            checkWinCondition();
        }

        function checkWinCondition() {
            if (money >= 500) {
                alert("恭喜你贏了！你成功管理了水資源並賺到了500元。");
            }
        }

        window.addEventListener('load', initGame);
        window.addEventListener('resize', checkOrientation);

        // 鍵盤控制
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowUp':
                    move('up');
                    break;
                case 'ArrowDown':
                    move('down');
                    break;
                case 'ArrowLeft':
                    move('left');
                    break;
                case 'ArrowRight':
                    move('right');
                    break;
                case 'Enter':
                    endTurn();
                    break;
            }
        });
    </script>
</body>
</html>